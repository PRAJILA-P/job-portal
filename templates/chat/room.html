<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat Room - {{ room_name }}</title>
  <style>
    body { font-family: Arial; margin: 20px; }
    #chat-container { width: 60%; margin:auto; border:1px solid #ccc; border-radius:8px; padding:10px; }
    #chat-log { height:300px; overflow-y:auto; border:1px solid #ddd; border-radius:6px; padding:10px; margin-bottom:10px; background:#f9f9f9;}
    #chat-log div { margin:5px 0; padding:6px 10px; border-radius:6px; max-width:70%; word-wrap:break-word; }
    .sent { background:#007bff; color:white; margin-left:auto; text-align:right; }
    .received { background:#e4e6eb; color:black; margin-right:auto; text-align:left; }
    #chat-controls { display:flex; }
    #chat-message-input { flex:1; padding:10px; border-radius:6px; border:1px solid #ccc; }
    #chat-message-submit { margin-left:10px; padding:10px 20px; border:none; border-radius:6px; background:#007bff; color:white; cursor:pointer; }
    #chat-message-submit:hover { background:#0056b3; }
  </style>
</head>
<body>
  <div id="chat-container">
    <h2>Room: {{ room_name }}</h2>
    <div id="chat-log"></div>

    <div id="chat-controls">
      <input id="chat-message-input" type="text" placeholder="Type a message...">
      <button id="chat-message-submit">Send</button>
    </div>
  </div>

<script>
  const roomName = "{{ room_name }}";
  const username = "{{ user.username|default:'Guest' }}";

  // âœ… WebSocket works for http:// and https://
  const chatSocket = new WebSocket(
      (window.location.protocol === "https:" ? "wss://" : "ws://")
      + window.location.host
      + "/ws/chat/"
      + roomName
      + "/"
  );

  // When a message is received from the server
  chatSocket.onmessage = function(e) {
      const data = JSON.parse(e.data);
      const log = document.querySelector('#chat-log');
      const div = document.createElement("div");
      div.className = (data.username === username) ? "sent" : "received";
      div.textContent = `${data.username}: ${data.message}`;
      log.appendChild(div);
      log.scrollTop = log.scrollHeight; // auto scroll down
  };

  // When Send button is clicked
  document.querySelector('#chat-message-submit').onclick = function() {
      const input = document.querySelector('#chat-message-input');
      const message = input.value.trim();
      if(message) {
          chatSocket.send(JSON.stringify({
              'message': message,
              'username': username
          }));
          input.value = "";
      }
  };

  // Allow pressing Enter to send
  document.querySelector('#chat-message-input').addEventListener("keyup", function(e){
      if(e.key === "Enter") {
          document.querySelector('#chat-message-submit').click();
      }
  });
</script>
</body>
</html>
